// var query = require('./query.js');
// var exec = require('child_process').exec;
var request = require('request');
var len = 0;
var step = 0;
var originArr = [];
var finalArr = [];
var codeArr = [];
var newCodeArr = [];
var distanceCode = '';
var finalCode = '';
var sti;
var empty = ['0x0', '0x0', '0x0', '0x0', '0x0', '0x0', '0x0', '0x0'];
var numCode = [
    ['1111', '1001', '1001', '1001', '1001', '1001', '1111', '0000'],
    ['0100', '0100', '0100', '0100', '0100', '0100', '0100', '0000'],
    ['1111', '0001', '0001', '1111', '1000', '1000', '1111', '0000'],
    ['1111', '0001', '0001', '1111', '0001', '0001', '1111', '0000'],
    ['1001', '1001', '1001', '1111', '0001', '0001', '0001', '0000'],
    ['1111', '1000', '1000', '1111', '0001', '0001', '1111', '0000'],
    ['1111', '1000', '1000', '1111', '1001', '1001', '1111', '0000'],
    ['1111', '0001', '0001', '0001', '0001', '0001', '0001', '0000'],
    ['1111', '1001', '1001', '1111', '1001', '1001', '1111', '0000'],
    ['1111', '1001', '1001', '1111', '0001', '0001', '1111', '0000'],
];
var dot = ['0000', '0000', '0000', '0000', '0000', '0000', '0100', '0000'];
var pre = '0x0,0xe7,0x92,0x92,0x92,0xe7,0x0,0x0,0x0,0x38,0x40,0x32,0x8,0x72,0x0,0x0,';
var face = [
    '0x0,0x0,0x0,0x4,0x4,0x4,0x3f,0x4,0x0,0x0,0x0,0x0,0x0,0x0,0x80,0x0,0x4,0x4,0x4,0x0,0x0,0x0,0x0,0x0,0x0,0x4,0x2a,0x11,0x0,0x0,0x0,0x0;0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x10,0x10,0x10,0xfe,0x10,0x0,0x44,0xaa,0x10,0x0,0x0,0x0,0x0,0x10,0x10,0x10,0x0,0x0,0x0,0x0,0x0',
    '0x0,0x0,0x0,0x0,0x0,0x0,0x7f,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xc7,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x10,0x10,0x0,0x0,0x0,0x0,0x0;0x0,0x0,0x0,0x0,0x0,0x0,0xfc,0x0,0x0,0x0,0x92,0x92,0x92,0x92,0x92,0x92,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x92,0x92,0x92,0x92,0x92,0x92,0x0,0x0',
    '0x0,0x0,0x0,0x1c,0x22,0x41,0x80,0x88,0x0,0x0,0x0,0x0,0x0,0x0,0x80,0x80,0x80,0x41,0x22,0x1c,0x0,0x0,0x0,0x0,0x81,0x2,0x2,0x1,0x0,0x0,0x0,0x0;0x0,0x0,0x0,0x0,0x0,0x0,0x1,0x1,0x0,0x0,0x0,0x38,0x44,0x82,0x1,0x11,0x81,0x40,0x40,0x80,0x0,0x0,0x0,0x0,0x1,0x82,0x44,0x38,0x0,0x0,0x0,0x0',
    '0x0,0x0,0x0,0x0,0x0,0x0,0x30,0xcc,0x0,0x0,0x0,0x0,0x0,0x1,0x2,0xc2,0x3,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x2,0x2,0x2,0x1,0x0,0x0,0x0,0x0;0x0,0x0,0x0,0x0,0x0,0xc0,0x20,0x23,0x0,0x0,0x0,0x0,0x0,0x0,0xc0,0x33,0x20,0x20,0x20,0xc0,0x0,0x0,0x0,0x0,0xc,0x0,0x0,0x0,0x0,0x0,0x0,0x0',
    '0x0,0x0,0x0,0x0,0x0,0x38,0x44,0x3,0x0,0x0,0x0,0x0,0x0,0x0,0x40,0x80,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x3f,0x0,0x0,0x0;0x0,0x0,0x0,0x0,0x0,0x1,0x2,0x0,0x0,0x0,0x0,0x0,0x0,0xc0,0x22,0x1c,0x0,0x0,0x0,0x0,0xfc,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0',
    '0x0,0x0,0x0,0x0,0x4,0x6,0x9,0x9,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x9,0x10,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x80,0x0,0x0,0x0,0x3f,0x0,0x0;0x0,0x0,0x0,0x0,0x10,0x18,0x24,0x24,0x0,0x0,0x0,0x8,0x8,0x10,0x10,0x10,0x24,0x42,0x0,0x0,0x0,0x0,0x0,0x0,0x20,0x20,0x20,0x40,0x0,0x0,0x0,0x0',
    '0x0,0x0,0x0,0x0,0x4,0x6,0x9,0x9,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x9,0x10,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x80,0x0,0x0,0x0,0x3f,0x0,0x0;0x0,0x0,0x0,0x0,0x10,0x18,0x24,0x24,0x0,0x0,0x0,0x0,0x0,0x38,0x44,0x44,0x24,0x42,0x0,0x0,0x0,0x0,0x0,0x0,0x44,0x44,0x44,0x38,0x0,0x0,0x0,0x0'
];
//设备正在启动中，请稍后…
var loading = '0x40,0x21,0x31,0x21,0x1,0x1,0xe2,0x25,0x0,0xf0,0x10,0x10,0x10,0x10,0xe,0xf8,0x21,0x21,0x20,0x20,0x28,0x30,0x23,0xc,0x8,0x8,0x90,0x90,0x60,0x90,0xe,0x4;0x8,0xf,0x8,0x14,0x22,0x41,0x2,0xc,0x0,0xf0,0x20,0x20,0x40,0x80,0x40,0x30,0x30,0xdf,0x11,0x1f,0x11,0x11,0x1f,0x10,0x1e,0xf4,0x10,0xf0,0x10,0x10,0xf0,0x10;0x0,0x7f,0x0,0x0,0x0,0x0,0x10,0x10,0x0,0xfe,0x80,0x80,0x80,0x80,0x80,0xfc,0x10,0x10,0x10,0x10,0x10,0xff,0x0,0x0,0x80,0x80,0x80,0x80,0x80,0xfe,0x0,0x0;0x2,0x2,0x7f,0x4,0x4,0x8,0x18,0x17,0x0,0x0,0xfe,0x0,0x0,0x40,0x40,0xfc,0x30,0x50,0x90,0x10,0x10,0x17,0x10,0x0,0x40,0x40,0x40,0x40,0x40,0xfe,0x0,0x0;0x1,0x0,0x0,0x1f,0x10,0x10,0x1f,0x10,0x0,0xc0,0x80,0xfc,0x4,0x4,0xfc,0x0,0x10,0x17,0x14,0x24,0x24,0x47,0x84,0x0,0x0,0xfc,0x4,0x4,0x4,0xfc,0x4,0x0;0x0,0x0,0x7e,0x0,0x0,0xff,0x10,0x10,0x20,0x20,0x20,0x20,0xfc,0x24,0x24,0x24,0x24,0x22,0x4f,0xfa,0x40,0x1,0x2,0x0,0x24,0x24,0x44,0x44,0x84,0x14,0x8,0x0;0x1,0x1,0x21,0x3f,0x21,0x21,0x21,0x21,0x0,0x0,0x8,0xfc,0x8,0x8,0x8,0x8,0x21,0x3f,0x21,0x1,0x1,0x1,0x1,0x1,0x8,0xf8,0x8,0x0,0x0,0x0,0x0,0x0;0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x30,0x30,0x10,0x20,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0;0x0,0x47,0x30,0x23,0x0,0x7,0xf0,0x13,0x40,0xfc,0x40,0xf8,0x40,0xfe,0x0,0xf8,0x12,0x13,0x12,0x13,0x16,0x1a,0x12,0x2,0x8,0xf8,0x8,0xf8,0x8,0x8,0x28,0x10;0xe,0x79,0x8,0x8,0x7d,0x19,0x1d,0x2b,0x20,0x22,0xa4,0xa8,0xfc,0x4,0x4,0xfc,0x29,0x49,0x49,0x89,0x9,0x9,0x9,0x9,0x4,0x4,0xfc,0x4,0x4,0x4,0x14,0x8;0x10,0x1b,0x10,0x27,0x29,0x69,0xa9,0x29,0x0,0xf8,0x10,0xfe,0x0,0x0,0xfc,0x40,0x2a,0x2f,0x28,0x28,0x21,0x22,0x24,0x0,0x40,0xfe,0xa0,0x90,0x18,0xe,0x4,0x0;0x0,0x0,0x0,0x0,0x0,0x0,0x63,0x63,0x0,0x0,0x0,0x0,0x0,0x0,0x18,0x18,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0';
//休息一下下～
var rest = '0x10,0x18,0x10,0x10,0x27,0x20,0x60,0x61,0x40,0x60,0x40,0x48,0xfc,0xc0,0xe0,0x60,0xa1,0x22,0x22,0x24,0x28,0x20,0x20,0x0,0x50,0x50,0x48,0x4e,0x44,0x40,0x40,0x0;0x1,0x2,0x1f,0x10,0x1f,0x10,0x1f,0x10,0x0,0x0,0xf0,0x10,0xf0,0x10,0xf0,0x10,0x1f,0x0,0x9,0x28,0x28,0x68,0x7,0x0,0xf0,0x0,0x0,0x84,0x92,0x12,0xf0,0x0;0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x7f,0x0,0x0,0x0,0x0,0x0,0x0,0x4,0xfe,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0;0x0,0x7f,0x1,0x1,0x1,0x1,0x1,0x1,0x4,0xfe,0x0,0x0,0x0,0xc0,0x60,0x30,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x0,0x20,0x0,0x0,0x0,0x0,0x0,0x0,0x0;0x0,0x7f,0x1,0x1,0x1,0x1,0x1,0x1,0x4,0xfe,0x0,0x0,0x0,0xc0,0x60,0x30,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x0,0x20,0x0,0x0,0x0,0x0,0x0,0x0,0x0;0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x3f,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x4,0x40,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xf8,0x0,0x0,0x0,0x0,0x0,0x0,0x0';

function newDisplayLED(distance, callback) {
    clean();

    distanceCode = createNum(distance);

    if (distance < 5) {
        postData(distanceCode + ';' + face[0], callback);
    } else if (distance < 10) {
        postData(distanceCode + ';' + face[1], callback);
    } else if (distance < 20) {
        postData(distanceCode + ';' + face[2], callback);
    } else if (distance < 40) {
        postData(distanceCode + ';' + face[3], callback);
    } else if (distance < 60) {
        postData(distanceCode + ';' + face[4], callback);
    } else if (distance < 80) {
        postData(distanceCode + ';' + face[5], callback);
    } else {
        postData(distanceCode + ';' + face[6], callback);
    }
}

function createNum(num) {
    var num1 = parseInt(num / 10, 10);
    var num2 = parseInt(num - num1 * 10, 10);
    var num3 = num * 10 % 10;
    var numCodeArr = [];
    for (var i = 0; i < 8; i++) {
        numCodeArr[i] = numCode[num1][i] + numCode[num2][i];
    }
    for (var j = 8; j < 16; j++) {
        numCodeArr[j] = dot[j - 8] + numCode[num3][j - 8];
    }
    var distCode = pre;
    numCodeArr.forEach(function(e) {
        var hex = parseInt(e, 2).toString(16);
        distCode += ('0x' + hex + ',');
    });
    return distCode.slice(0, -1);
}

function initArr(data) {
    clean();

    postData(data);

    originArr = data.split(';');
    len = originArr.length;
    originArr.forEach(function(zifu, idx) {
        originArr[idx] = zifu.split(',');
        codeArr[4 * idx] = originArr[idx].slice(0, 8);
        codeArr[4 * idx + 1] = originArr[idx].slice(8, 16);
        codeArr[4 * idx + 2] = originArr[idx].slice(16, 24);
        codeArr[4 * idx + 3] = originArr[idx].slice(24, 32);
    });
    newCodeArr = codeArr;
    finalArr = originArr;
    // move();
    sti = setInterval(move, 200);
}

function clean() {
    len = step = 0;
    originArr = finalArr = codeArr = newCodeArr = [];
    distanceCode = finalCode = '';
    sti && clearInterval(sti);
}

function postData(data, callback) {
    request({
        uri: 'http://localhost:8338/display',
        method: 'POST',
        form: {
            'text': data
        },
        timeout: 2000
    }, function(err, res, body) {
        if (err) {
            console.log('display error, skip...');
            callback && callback();
        } else {
            callback && callback();
        }
    });
}

function move() {
    if (step < len * 2) {
        moveCode();
        display(finalArr);
        step++;
    } else {
        clean();
        // initArr(loading);
    }
}

function display(arr) {
    var str = '';
    arr.forEach(function(arr1, i) {
        str += arr1.join(',') + ';';
    });
    postData(str);
}

function moveCode() {
    newCodeArr.forEach(function(v, i) {
        if (i % 2 === 0) {
            newCodeArr[i] = (codeArr[i + 1] || empty);
        } else {
            newCodeArr[i] = (codeArr[i + 3] || empty);
        }
    });
    codeArr = newCodeArr;
    finalArr.forEach(function(v, i) {
        finalArr[i] = codeArr[4 * i].concat(codeArr[4 * i + 1], codeArr[4 * i + 2], codeArr[4 * i + 3]);
    });
}

function displayLoading() {
    initArr(loading);
}

function displayRest() {
    initArr(rest);
}

exports.displayDistance = newDisplayLED;
exports.displayLoading = displayLoading;
exports.displayRest = displayRest;